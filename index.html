<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–°–æ—Ü-–†–µ–π—Ç–∏–Ω–≥ –ê—Ä–µ–Ω–∞</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f0f2e" />
  <link rel="icon" href="data:," />

  <!-- tsParticles -->
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@3/tsparticles.bundle.min.js"></script>
  <!-- –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --bg:#0f0f2e;
      --card:#1f115a;
      --accent:#9b79ff;
      --accent2:#ff85d6;
      --radius:14px;
      --shadow:0 30px 80px -10px rgba(155,121,255,.4);
      --text:#eef;
      --transition:.35s cubic-bezier(.25,.8,.5,1);
    }
    *{box-sizing:border-box;}
    body {
      margin:0;
      font-family: "Segoe UI", system-ui,-apple-system,BlinkMacSystemFont;
      background: var(--bg);
      color: var(--text);
      min-height:100vh;
      position:relative;
      overflow-y:auto;
    }
    #tsparticles { position: fixed; inset:0; z-index:0; }
    .container {
      max-width: 1120px;
      margin:0 auto;
      padding:20px 14px 80px;
      position:relative;
      z-index:1;
    }
    .header {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      justify-content: space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .title {
      font-size:2.4rem;
      margin:0;
      line-height:1;
      background: linear-gradient(90deg,var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight:700;
    }
    .sub { font-size:.9rem; margin-top:4px; color:#ccc; }
    .grid {
      display:grid;
      gap:20px;
      grid-template-columns: repeat(auto-fit,minmax(300px,1fr));
    }
    .card {
      background: rgba(30,20,80,.9);
      border-radius: var(--radius);
      padding:18px 22px 24px;
      position:relative;
      box-shadow: var(--shadow);
      overflow:hidden;
      transition: var(--transition);
      border:1px solid rgba(255,255,255,.05);
    }
    .card:hover { transform: translateY(-2px); }
    .card-header {
      display:flex;
      justify-content: space-between;
      align-items:center;
      margin-bottom:12px;
      gap:6px;
      flex-wrap:wrap;
    }
    .badge {
      padding:6px 14px;
      background: linear-gradient(135deg,var(--accent2),var(--accent));
      border-radius:999px;
      font-size:.6rem;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .stats { display:grid; gap:6px; margin-bottom:10px; }
    .row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.08); font-size:.85rem; }
    .btn {
      background: linear-gradient(135deg,var(--accent), var(--accent2));
      border:none;
      padding:12px 16px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      color:#fff;
      position:relative;
      overflow:hidden;
      transition: transform .2s, filter .2s;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn:active { transform:scale(.95); }
    .small { font-size:.75rem; color:#bbb; }
    .leaderboard { display:flex; flex-direction:column; gap:6px; margin-top:4px; }
    .entry {
      background: rgba(255,255,255,.05);
      padding:10px 14px;
      border-radius:8px;
      display:flex;
      justify-content:space-between;
      font-size:.85rem;
      position:relative;
      overflow:hidden;
    }
    .currency {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .stars {
      display:flex;
      gap:4px;
      font-size:1rem;
      align-items:center;
    }
    .pulse {
      animation:pulse .55s ease;
    }
    @keyframes pulse {
      0%{ transform:scale(1); }
      50%{ transform:scale(1.07); }
      100%{ transform:scale(1); }
    }
    .confetti-burst { position:absolute; inset:0; pointer-events:none; }
    .clicker-stats { display:flex; gap:16px; flex-wrap:wrap; }
    .pill { background: rgba(255,255,255,.08); padding:4px 14px; border-radius:999px; font-size:.55rem; margin-left:4px; }
    .upgrade-tag { background: rgba(255,255,255,.12); padding:3px 10px; border-radius:999px; font-size:.55rem; }
    .faded { opacity:.7; }
    .bar {
      background: rgba(255,255,255,.08);
      border-radius:6px;
      position:relative;
      height:8px;
      overflow:hidden;
    }
    .bar-inner {
      height:100%;
      background: linear-gradient(135deg,var(--accent2), var(--accent));
      width:0%;
      transition: width .6s ease;
    }
    .flex { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    /* wheel spin animation */
    .wheel {
      width:160px;
      height:160px;
      border-radius:50%;
      position:relative;
      background: conic-gradient(
        #7c5cff 0deg 60deg,
        #ff85d6 60deg 120deg,
        #5bf5ff 120deg 180deg,
        #ffda6b 180deg 240deg,
        #ffa5a5 240deg 300deg,
        #d19bff 300deg 360deg
      );
      border:6px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:0;
      transition: transform 4s cubic-bezier(.17,.67,.83,.67);
      box-shadow:0 25px 70px -10px rgba(155,121,255,.5);
    }
    .pointer {
      position:absolute;
      top:-10px;
      font-size:32px;
      color:#fff;
      text-shadow:0 0 14px rgba(255,255,255,.7);
    }
    .slot { display:flex; gap:12px; margin-bottom:6px; }
    .reel {
      flex:1;
      background: rgba(255,255,255,.03);
      border-radius:10px;
      padding:16px;
      font-size:2.4rem;
      text-align:center;
      min-height:80px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      box-shadow: inset 0 0 12px rgba(255,255,255,.07);
    }
    .grow { transform: scale(1.03); }
    .share-box { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .tag { background: rgba(255,255,255,.1); padding:5px 12px; border-radius:999px; font-size:.6rem; }
    .highlight { background: rgba(255,255,255,.12); padding:4px 12px; border-radius:8px; }
  </style>
</head>
<body>
  <div id="tsparticles"></div>
  <div class="container">
    <div class="header">
      <div>
        <h1 class="title">üî• –°–æ—Ü-–†–µ–π—Ç–∏–Ω–≥ –ê—Ä–µ–Ω–∞</h1>
        <div class="sub">–ö–ª–∏–∫–µ—Ä + —Ä–æ—Å—Ç–∏–ª–∫–∞ + –µ–∂–µ–¥–Ω–µ–≤–∫–∞ + –±–æ–Ω—É—Å—ã. –í—Å—ë —Å —Ç–µ–ª–µ–≥–æ–π, —à–∞—Ä–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —á–∞—Ç.</div>
      </div>
      <div class="currency">
        <div class="small">‚≠ê –ó–≤—ë–∑–¥–æ—á–∫–∏:</div>
        <div class="stars"><span id="star-count">0</span> ‚ú®</div>
      </div>
    </div>

    <div class="grid">
      <!-- –ø—Ä–æ—Ñ–∏–ª—å -->
      <div class="card" id="profile-card">
        <div class="card-header">
          <div class="flex">
            <div>
              <div style="font-weight:700; font-size:1.3rem;" id="user-name">Anon</div>
              <div class="small" id="user-id">ID: ‚Äî</div>
            </div>
            <div class="pill" id="title-badge">–ù–æ–≤–∏—á–æ–∫</div>
          </div>
          <div class="badge" id="prestige-badge">x1.00</div>
        </div>
        <div class="stats" id="profile-stats">
          <!-- injected -->
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
          <button class="btn" id="daily-btn">üî• /daily</button>
          <button class="btn" id="prestige-btn">‚≠ê –ü—Ä–µ—Å—Ç–∏–∂</button>
          <button class="btn" id="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="small" style="margin-top:8px;">–†–µ–π—Ç–∏–Ω–≥, —Å—Ç—Ä–∏–∫, —Å–∏–ª–∞ –∫–ª–∏–∫–∞, –∑–≤—ë–∑–¥–æ—á–∫–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Ç–≤–æ–µ–º—É Telegram-–ø—Ä–æ—Ñ–∏–ª—é.</div>
      </div>

      <!-- –∫–ª–∏–∫–µ—Ä -->
      <div class="card">
        <div class="card-header">
          <div>üöÄ –†–æ—Å—Ç–∏–ª–∫–∞ / –ö–ª–∏–∫–µ—Ä</div>
          <div class="small">–ñ–º–∏ ‚Äî –∫–∞—á–∞–π —Ä–µ–π—Ç–∏–Ω–≥, –∞–ø–≥—Ä–µ–π–¥—å –∫–ª–∏–∫–∏ –∏ –∞–≤—Ç–æ–∫–ª–∏–∫ –∑–∞ –∑–≤—ë–∑–¥–æ—á–∫–∏.</div>
        </div>
        <div class="clicker-stats">
          <div class="entry" style="flex:1;">
            <div>–°–∏–ª–∞ –∫–ª–∏–∫–∞</div><div id="click-power">1</div>
          </div>
          <div class="entry" style="flex:1;">
            <div>–ê–≤—Ç–æ–∫–ª–∏–∫ lvl</div><div id="auto-level">0</div>
          </div>
          <div class="entry" style="flex:1;">
            <div>–ö–ª–∏–∫–æ–≤ –≤—Å–µ–≥–æ</div><div id="total-clicks">0</div>
          </div>
        </div>
        <div style="margin:12px 0; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="btn-click">+ –†–µ–π—Ç–∏–Ω–≥</button>
          <button class="btn" id="btn-upgrade-click">–ê–ø–≥—Ä–µ–π–¥ —Å–∏–ª—ã (<span id="next-click-cost">4</span>‚≠ê)</button>
          <button class="btn" id="btn-upgrade-auto">–ê–ø–≥—Ä–µ–π–¥ –∞–≤—Ç–æ–∫–ª–∏–∫–∞ (<span id="next-auto-cost">5</span>‚≠ê)</button>
        </div>
        <div class="small" id="clicker-feedback">–ü—Ä–æ–∫–∞—á–∏–≤–∞–π, —á—Ç–æ–±—ã –±–æ–ª—å—à–µ.</div>
        <div class="share-box">
          <button class="btn" id="btn-share">üì£ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ —á–∞—Ç</button>
        </div>
      </div>

      <!-- –∫–æ–ª–µ—Å–æ -->
      <div class="card">
        <div class="card-header">
          <div>üé° –ö–æ–ª–µ—Å–æ —É–¥–∞—á–∏</div>
          <div class="small">–†–∞–∑ –≤ –¥–µ–Ω—å –∫—Ä—É—Ç–∏ –∏ –ø–æ–ª—É—á–∞–π –±–æ–Ω—É—Å—ã</div>
        </div>
        <div style="display:flex; gap:18px; align-items:center; flex-wrap:wrap;">
          <div style="position:relative;">
            <div class="pointer">‚ñº</div>
            <div id="wheel" class="wheel"></div>
          </div>
          <div style="flex:1;">
            <div id="wheel-result" style="font-weight:600; font-size:1.1rem;">–ñ–º–∏ –∏ –ª–æ–≤–∏ —É–¥–∞—á—É!</div>
            <button class="btn" id="spin-wheel" style="margin-top:8px;">–ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ</button>
          </div>
        </div>
      </div>

      <!-- —Å–ª–æ—Ç -->
      <div class="card">
        <div class="card-header">
          <div>üé∞ –°–ª–æ—Ç-–º–∞—à–∏–Ω–∞</div>
          <div class="small">–ü–æ–≤–µ–∑—ë—Ç? –í—ã–∏–≥—Ä—ã–≤–∞–π —Ä–µ–π—Ç–∏–Ω–≥</div>
        </div>
        <div class="slot">
          <div class="reel" id="r1">?</div>
          <div class="reel" id="r2">?</div>
          <div class="reel" id="r3">?</div>
        </div>
        <div class="small" id="slot-result">–ñ–º–∏ ¬´–ò–≥—Ä–∞—Ç—å¬ª, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É–¥–∞—á—É.</div>
        <button class="btn" id="spin-slot" style="margin-top:6px;">–ò–≥—Ä–∞—Ç—å</button>
      </div>

      <!-- –ª–∏–¥–µ—Ä–±–æ—Ä–¥ -->
      <div class="card">
        <div class="card-header">
          <div>üèÜ –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–æ–ø</div>
          <div class="small">–°—Ä–∞–≤–Ω–∏ —Å–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥</div>
        </div>
        <div class="leaderboard" id="leaderboard"></div>
        <div style="margin-top:8px;">
          <button class="btn" id="clear-lb">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button class="btn" id="show-global">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–ø</button>
        </div>
      </div>
    </div>

    <!-- FAQ -->
    <div style="margin-top:28px;">
      <div class="card">
        <div class="card-header">
          <div>‚ùì FAQ / –ö–∞–∫ –∏–≥—Ä–∞—Ç—å</div>
        </div>
        <div class="small">
          <ul>
            <li>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–∑ Telegram WebApp –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</li>
            <li>/daily ‚Äî —Ä–∞–∑ –≤ 24 —á–∞—Å–∞ —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞, –≤–ª–∏—è–µ—Ç —Å—Ç—Ä–∏–∫ –∏ –ø—Ä–µ—Å—Ç–∏–∂.</li>
            <li>–ü—Ä–µ—Å—Ç–∏–∂: –ø—Ä–∏ ‚â•1000 —Ä–µ–π—Ç–∏–Ω–≥ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –¥–æ 100, –º–Ω–æ–∂–∏—Ç–µ–ª—å —Ä–∞—Å—Ç—ë—Ç.</li>
            <li>–ö–ª–∏–∫–µ—Ä ‚Äî –∫–∞—á–∞–π —Ä–µ–π—Ç–∏–Ω–≥ –≤—Ä—É—á–Ω—É—é, –∞–ø–≥—Ä–µ–π–¥ –∑–∞ –∑–≤—ë–∑–¥–æ—á–∫–∏.</li>
            <li>–ê–≤—Ç–æ–∫–ª–∏–∫ ‚Äî –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥, –ø—Ä–æ–∫–∞—á–∏–≤–∞–µ—Ç—Å—è.</li>
            <li>–ö–æ–ª–µ—Å–æ –∏ —Å–ª–æ—Ç ‚Äî –¥–∞—é—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –±–æ–Ω—É—Å—ã.</li>
            <li>–ù–∞–∂–º–∏ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ—è–≤–∏—Ç—Å—è –≤ —á–∞—Ç–µ.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" style="position:fixed; bottom:16px; right:16px; z-index:999;"></div>

  <script>
    // ---- –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ----
    const API_BASE = ""; // –µ—Å–ª–∏ backend –æ—Ç–¥–µ–ª—å–Ω–æ: –Ω–∞–ø—Ä–∏–º–µ—Ä "https://your-backend.domain"
    const chat_id = new URLSearchParams(window.location.search).get("chat_id") || 0;

    // Toast
    function toast(msg, duration=2200) {
      const t = document.createElement("div");
      t.className = "toast";
      t.style.cssText = "background:rgba(255,255,255,.08);color:#fff;padding:10px 16px;border-radius:8px;margin-top:6px;backdrop-filter:blur(10px);font-weight:600;min-width:180px;";
      t.textContent = msg;
      document.getElementById("toast-container").appendChild(t);
      setTimeout(() => {
        t.style.opacity = "0";
        setTimeout(()=>t.remove(), 300);
      }, duration);
    }

    // Telegram WebApp
    const isTelegram = !!window.Telegram?.WebApp;
    if (isTelegram) {
      window.Telegram.WebApp.expand();
      window.Telegram.WebApp.ready();
    }

    function getInitDataStr() {
      if (isTelegram) return window.Telegram.WebApp.initData || "";
      const params = new URLSearchParams(window.location.search);
      return params.get("init_data") || "";
    }

    // state
    let profile = {
      user_id: null,
      username: "Anon",
      rating: 100,
      title: "–ù–æ–≤–∏—á–æ–∫",
      streak: 0,
      prestige_multiplier: 1.0,
      prestige_level: 0,
      stars: 0,
      click_power:1,
      total_clicks:0,
      auto_click_level:0,
      next_daily_available_in:0,
    };
    const LB_KEY = "sr_arena_lb_v2";

    // local leaderboard
    function loadLocalLeaderboard() {
      try { return JSON.parse(localStorage.getItem(LB_KEY) || "[]"); } catch { return []; }
    }
    function saveLocalLeaderboard(lb) {
      localStorage.setItem(LB_KEY, JSON.stringify(lb));
    }
    function updateLocalLeaderboard() {
      const lb = loadLocalLeaderboard();
      const exist = lb.find(e => e.user_id === profile.user_id);
      if (exist) {
        exist.rating = profile.rating;
        exist.updated = Date.now();
      } else {
        lb.push({ user_id: profile.user_id, username: profile.username, rating: profile.rating, updated: Date.now() });
      }
      lb.sort((a,b)=>b.rating - a.rating);
      saveLocalLeaderboard(lb.slice(0, 30));
      renderLeaderboard(lb.slice(0,30));
    }
    function renderLeaderboard(arr) {
      const container = document.getElementById("leaderboard");
      container.innerHTML = "";
      const list = arr || loadLocalLeaderboard();
      if (!list.length) {
        container.innerHTML = "<div class='small'>–¢–æ–ø –ø—É—Å—Ç ‚Äî –∫–∞—á–∞–π —Ä–µ–π—Ç–∏–Ω–≥.</div>";
        return;
      }
      list.slice(0,10).forEach((e,i)=>{
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `<div>${i+1}. ${e.username}</div><div>${e.rating} ‚òÖ</div>`;
        container.appendChild(div);
      });
    }

    function setProfileUI() {
      document.getElementById("user-name").innerText = profile.username;
      document.getElementById("user-id").innerText = `ID: ${profile.user_id}`;
      document.getElementById("prestige-badge").innerText = `x${profile.prestige_multiplier.toFixed(2)}`;
      document.getElementById("title-badge").innerText = profile.title;
      document.getElementById("star-count").innerText = profile.stars;
      document.getElementById("click-power").innerText = profile.click_power;
      document.getElementById("total-clicks").innerText = profile.total_clicks;
      document.getElementById("auto-level").innerText = profile.auto_click_level;
      // stats
      const stats = document.getElementById("profile-stats");
      stats.innerHTML = "";
      const rows = [
        ["–†–µ–π—Ç–∏–Ω–≥", profile.rating + " ‚òÖ"],
        ["–°—Ç—Ä–∏–∫", profile.streak + " –¥–Ω."],
        ["–ü—Ä–µ—Å—Ç–∏–∂ —É—Ä–æ–≤–µ–Ω—å", profile.prestige_level],
        ["–°–ª–µ–¥—É—é—â–∏–π /daily", profile.next_daily_available_in ? `${Math.ceil(profile.next_daily_available_in/3600)}—á` : "–ú–æ–∂–Ω–æ"],
      ];
      rows.forEach(([k,v])=>{
        const r = document.createElement("div");
        r.className = "row";
        r.innerHTML = `<div>${k}</div><div>${v}</div>`;
        stats.appendChild(r);
      });
      // costs
      document.getElementById("next-click-cost").innerText = (profile.click_power +1)**2;
      document.getElementById("next-auto-cost").innerText = (profile.auto_click_level +1)*5;
    }

    // API calls
    async function post(path, body) {
      try {
        const resp = await fetch(`${API_BASE || ""}${path}`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(body)
        });
        return await resp.json();
      } catch (e) {
        console.warn("API error", e);
        return null;
      }
    }

    async function syncProfile() {
      const init_data = getInitDataStr();
      if (!init_data && !API_BASE) {
        // –æ—Ñ—Ñ–ª–∞–π–Ω fallback
        const stored = JSON.parse(localStorage.getItem("sr_offline_profile")||"{}");
        if (stored.user_id) profile = {...profile, ...stored};
        setProfileUI();
        updateLocalLeaderboard();
        return;
      }
      const res = await post("/api/profile", { init_data, chat_id: Number(chat_id) });
      if (res && res.ok) {
        Object.assign(profile, {
          user_id: res.user.user_id,
          username: res.user.username,
          rating: res.user.rating,
          title: res.user.title,
          streak: res.user.streak,
          prestige_multiplier: res.user.prestige_multiplier,
          prestige_level: res.user.prestige_level,
          stars: res.user.stars,
          click_power: res.user.click_power,
          total_clicks: res.user.total_clicks,
          auto_click_level: res.user.auto_click_level,
          next_daily_available_in: res.user.next_daily_available_in,
        });
        setProfileUI();
        updateLocalLeaderboard();
      } else {
        toast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è");
      }
    }

    async function doDaily() {
      if (!profile.user_id) return;
      const init_data = getInitDataStr();
      const res = await post("/api/daily", { init_data, chat_id: Number(chat_id) });
      if (res && res.ok) {
        profile.rating = res.user.rating;
        profile.streak = res.daily.streak;
        profile.prestige_multiplier = res.user.prestige_multiplier;
        profile.prestige_level = res.user.prestige_level;
        profile.stars = res.user.stars;
        profile.next_daily_available_in = res.user.next_daily_available_in;
        setProfileUI();
        updateLocalLeaderboard();
        toast(`Œî ${res.daily.delta} —Ä–µ–π—Ç–∏–Ω–≥–∞`);
        if (res.daily.delta > 15) bigConfetti();
      } else if (res) {
        toast("–ñ–¥–∏ /daily: " + (res.detail || ""));
      }
    }

    async function spinWheel() {
      if (!profile.user_id) return;
      const init_data = getInitDataStr();
      const res = await post("/api/wheel", { init_data, chat_id: Number(chat_id) });
      if (res && res.ok) {
        profile.rating = res.user.rating;
        profile.prestige_multiplier = res.user.prestige_multiplier;
        profile.stars = res.user.stars;
        setProfileUI();
        updateLocalLeaderboard();
        document.getElementById("wheel-result").innerText = `–í—ã–ø–∞–ª–æ: ${res.result}`;
        toast("–ö–æ–ª–µ—Å–æ: " + res.result);
        if (res.result.includes("+100") || res.result.includes("x1.1")) bigConfetti();
        animateWheel();
      }
    }

    async function spinSlot() {
      if (!profile.user_id) return;
      const init_data = getInitDataStr();
      const res = await post("/api/slot", { init_data, chat_id: Number(chat_id) });
      if (res && res.ok) {
        profile.rating = res.user.rating;
        setProfileUI();
        updateLocalLeaderboard();
        document.getElementById("r1").innerText = res.reels[0];
        document.getElementById("r2").innerText = res.reels[1];
        document.getElementById("r3").innerText = res.reels[2];
        document.getElementById("slot-result").innerText = res.payout > 0 ? `–í—ã–∏–≥—Ä—ã—à +${res.payout}` : "–ü—É—Å—Ç–æ";
        toast("–°–ª–æ—Ç: " + (res.payout > 0 ? `+${res.payout}` : "–Ω–∏—á–µ–≥–æ"));
        if (res.payout >= 200) bigConfetti();
      }
    }

    async function doClick() {
      if (!profile.user_id) return;
      const init_data = getInitDataStr();
      const res = await post("/api/click", { init_data, chat_id: Number(chat_id) });
      if (res && res.ok) {
        profile.rating = res.new_rating;
        profile.total_clicks = res.total_clicks;
        profile.click_power = res.click_power;
        profile.stars = res.stars;
        setProfileUI();
        updateLocalLeaderboard();
        toast(`+${res.gain} —Ä–µ–π—Ç–∏–Ω–≥–∞`);
      }
    }

    async function upgrade(type) {
      if (!profile.user_id) return;
      const init_data = getInitDataStr();
      const res = await post("/api/upgrade", { init_data, chat_id: Number(chat_id), type });
      if (res && res.ok) {
        profile.rating = res.user.rating;
        profile.click_power = res.user.click_power;
        profile.auto_click_level = res.user.auto_click_level;
        profile.stars = res.user.stars;
        setProfileUI();
        toast("–ê–ø–≥—Ä–µ–π–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω");
      } else if (res) {
        toast(res.detail || "–û—à–∏–±–∫–∞ –∞–ø–≥—Ä–µ–π–¥–∞");
      }
    }

    function shareProgress() {
      const summary = `–†–µ–π—Ç–∏–Ω–≥: ${profile.rating}, —Å–∏–ª–∞ –∫–ª–∏–∫–∞: ${profile.click_power}, –∑–≤—ë–∑–¥: ${profile.stars}`;
      if (isTelegram) {
        window.Telegram.WebApp.sendData(JSON.stringify({ action: "share", text: summary }));
      } else {
        toast("–û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –∏–∑ Telegram");
      }
    }

    // –∞–≤—Ç–æ–∫–ª–∏–∫–µ—Ä
    setInterval(async () => {
      if (profile.auto_click_level > 0) {
        await doClick();
      }
    }, 5000); // –º–æ–∂–Ω–æ –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å

    // ---- –≤–∏–∑—É–∞–ª–∫–∏ ----
    function bigConfetti() {
      confetti({
        particleCount: 120,
        spread: 160,
        origin: { y: 0.6 },
        colors: ['#9b79ff', '#ff85d6', '#ffffff'],
      });
    }
    function animateWheel() {
      const w = document.getElementById("wheel");
      const deg = 720 + Math.floor(Math.random() * 360);
      w.style.transform = `rotate(${deg}deg)`;
      setTimeout(() => {
        w.style.transform = "";
      }, 4500);
    }

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    document.getElementById("daily-btn").addEventListener("click", async () => {
      await doDaily();
      const el = document.getElementById("profile-card");
      el.classList.add("pulse");
      setTimeout(()=>el.classList.remove("pulse"), 500);
    });
    document.getElementById("spin-wheel").addEventListener("click", spinWheel);
    document.getElementById("spin-slot").addEventListener("click", spinSlot);
    document.getElementById("btn-click").addEventListener("click", doClick);
    document.getElementById("btn-upgrade-click").addEventListener("click", () => upgrade("click_power"));
    document.getElementById("btn-upgrade-auto").addEventListener("click", () => upgrade("auto_click"));
    document.getElementById("refresh-btn").addEventListener("click", syncProfile);
    document.getElementById("prestige-btn").addEventListener("click", () => {
      if (profile.rating < 1000) {
        toast("–ù—É–∂–Ω–æ ‚â•1000 —Ä–µ–π—Ç–∏–Ω–≥–∞");
        return;
      }
      profile.prestige_level +=1;
      profile.prestige_multiplier += 0.1;
      profile.rating = 100;
      setProfileUI();
      updateLocalLeaderboard();
      toast("–ü—Ä–µ—Å—Ç–∏–∂ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω x" + profile.prestige_multiplier.toFixed(2));
      bigConfetti();
    });
    document.getElementById("clear-lb").addEventListener("click", () => {
      localStorage.removeItem(LB_KEY);
      renderLeaderboard([]);
    });
    document.getElementById("show-global").addEventListener("click", async () => {
      if (!API_BASE) { toast("–ù—É–∂–µ–Ω backend –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ç–æ–ø–∞"); return; }
      try {
        const resp = await fetch(`${API_BASE}/api/leaderboard?scope=global&limit=10`);
        const data = await resp.json();
        if (data.ok) {
          const list = data.leaderboard.map((u,i)=>({username:u.username, rating:u.rating}));
          renderLeaderboard(list.map((u,i)=>({...u, user_id:i})));
        }
      } catch (e) { toast("–û—à–∏–±–∫–∞ —Ç–æ–ø–∞"); }
    });
    document.getElementById("btn-share").addEventListener("click", shareProgress);

    // init tsParticles
    tsParticles.load("tsparticles", {
      fullScreen: { enable: true },
      particles: {
        number: { value: 60, density: { enable: true, area: 800 } },
        color: { value: ["#9b79ff", "#ff85d6", "#5bf5ff"] },
        shape: { type: "circle" },
        opacity: { value: 0.2, random: true },
        size: { value: { min: 3, max: 7 } },
        move: { enable: true, speed: 1, direction: "none", outModes: "bounce" },
        links: { enable: true, distance: 120, color: "#ffffff", opacity: 0.05, width: 1 }
      },
      interactivity: {
        events: { onHover: { enable: true, mode: "grab" }, onClick: { enable: true, mode: "push" } },
        modes: { push: { quantity: 3 } }
      },
      detectRetina: true
    });

    // —Å—Ç–∞—Ä—Ç
    (async ()=>{
      if (isTelegram) {
        const user = window.Telegram.WebApp.initDataUnsafe?.user;
        if (user) {
          profile.username = user.username || `${user.first_name||""} ${user.last_name||""}`.trim();
          profile.user_id = user.id;
        }
      }
      await syncProfile();
    })();

  </script>
</body>
</html>
